name: Build Test

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - "packages/sveltekit/**"
      - "test/**"
  pull_request:
    branches: [main, master]
    paths:
      - "packages/sveltekit/**"
      - "test/**"

jobs:
  build-test:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🛠️ Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 🏗️ Build adapter package
        run: |
          cd packages/sveltekit
          bun install
          bun run build
          bun link

      - name: 🏗️ Build test project
        run: |
          cd test
          bun install
          bun run build
          bun link sveltekit-exec-adapter

      - name: 🧪 Test executable (Unix)
        if: runner.os != 'Windows'
        run: |
          cd test
          chmod +x dist/test-example
          ./dist/test-example &
          sleep 5
          curl -f http://localhost:3000 || exit 1
          pkill -f test-example
        shell: bash

      - name: 🧪 Test executable (Windows)
        if: runner.os == 'Windows'
        run: |
          cd test
          bun run Testing/Windows/test-metadata.js ./dist/test-example.exe
          Start-Process -FilePath "dist\test-example.exe" -PassThru
          Start-Sleep -Seconds 5
          try {
            Invoke-WebRequest -Uri "http://localhost:3000" -UseBasicParsing
          } catch {
            Write-Error "Failed to connect to executable"
            exit 1
          } finally {
            Get-Process | Where-Object {$_.ProcessName -like "*test-example*"} | Stop-Process -Force
          }
        shell: powershell
